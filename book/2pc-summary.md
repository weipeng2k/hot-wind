# 共识协议：两阶段提交

## 问题

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;日常我们都有银行转账的经历，一个*用户A*从*银行X*的账户上转了**100元**到*用户B银行Y*的账户。如果单独分析*用户A*和*用户B*在各自银行账户的金额变化，它们就是独立的本地事务，但是由于这个场景是跨多个数据源，所以它是一个分布式事务场景，而分布式事务代表的是全局事务。

<center>
<img src="https://weipeng2k.github.io/hot-wind/resources/2pc-summary/bank-transfer.png" width="50%" />
</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如上图所示，*用户A*在*银行X*账户的扣款以及*用户B*在*银行Y*账户的存款是一个全局事务，它也符合事务的**ACID原则**，尤其是要兑现**原子性（Atomicity）**，也就是要么这两个操作全部成功，要么全部失败，没有中间状态。如果把这两个操作视作两个节点，在转账场景中，它们就形成了一个更大范畴的分布式系统（虽然*银行X和Y*的系统并不相同），而要确保分布式事务的原子性，需要保证：

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（1）**安全性（Safety）**，所有节点共进退，要么成功，要么失败；

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;（2）**存活性（Liveness）**，所有节点正常，则成功。可以允许有异常节点，但最终需要有一个一致结果，且不能一直等待。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;参与分布式事务的多个节点需要对事务的提交或回滚达成一致，其实事务的提交与否和就一个值多节点达成一致，在本质上是同一回事，这就涉及到了分布式一致性问题。根据**CAP原理**，由于分区已经客观存在，保证安全性和存活性的必要条件就是保证一致性（Consistency），确保分区环境下的一致性的协议有许多，常见的就是两阶段提交（Two Phase Commit）。

## 协议

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;两阶段提交协议为了为了保持跨多个节点全局事务的ACID特性，通过引入一个协调者组件来统一掌控所有节点（或称作参与者）的操作结果并最终指示这些节点是否要把操作结果进行真正的提交（比如将更新后的数据写入磁盘等等）。该协议的算法思路可以概括为：协调者先问询所有参与者的处理意见，参与者将结果通知到协调者；再由协调者根据所有反馈结果决定各参与者接下来是提交还是中止。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;两阶段提交涉及到的角色一般有三个：*应用程序*、*协调者（或称作事务管理器）*和*参与者（或称作资源管理器）*。由*应用程序*发起操作，*协调者*一般是独立部署的中间件，而*参与者*是关系型数据库，*协调者*和*参与者*之间通过**XA协议**进行沟通。两阶段分为：准备阶段和提交阶段，分别应对投票和执行两个场景，其中准备阶段如下图所示：

<center>
<img src="https://weipeng2k.github.io/hot-wind/resources/2pc-summary/2PC-prepare-phase.png" width="50%" />
</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;准备阶段是由*应用程序*发起，通过*协调者*将提交事务的请求发送给所有*参与者*，*参与者*收到请求后在本地记录日志并将处理结果返回给*协调者*，然后等待最终命令，此时不做提交，对于外部数据变更是不可见的。处理结果只有两种，同意或中止。该阶段完成后，整体事务进入提交阶段，如下图所示：

<center>
<img src="https://weipeng2k.github.io/hot-wind/resources/2pc-summary/2PC-commit-phase.png" width="50%" />
</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*协调者*根据准备阶段收集到各*参与者*返回的处理结果集合进行判定，如果全部为同意，则向所有*参与者*发起提交命令，如果存在中止，则向所有*参与者*发起中止命令，当所有*参与者*响应命令后，整体事务完成。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可以看到两阶段提交协议是一种非常朴素的分布式一致性协议，依靠*协调者*来协同各*参与者*，确保不同*参与者*的状态一致。在安全性上能够确保所有节点有一致的意愿，但是在存活性上是存在一些问题的，比如：*协调者*在事务执行中突然崩溃导致*参与者*出现悬停，接下来我们运用**CAP原理**和**拜占庭将军问题**分析一下二阶段提交的一些问题。

## 分析
