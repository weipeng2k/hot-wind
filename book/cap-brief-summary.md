# CAP小结

# CAP的证明

在2000年的分布式计算原理会议（ACM Symposium on Principles of Distributed Computing, PODC）上，Brewer提出了一个猜想：对一个Web服务是无法同时保证一致性、可用性和分区容忍性。MIT的Lynch等人针对这个猜想做了详细的论证和分析，一定程度上形式化证明了该猜想，并基于该猜想，探讨了分布式环境下，如何能够更实际的面对和处理这三者之间的关系。

Lynch在文章一中尝试证明Brewer的猜想，在Web服务广泛使用的当下（2000年），对于可用性的要求越发高，在理论上研究Brewer的猜想变得有现实意义。

证明：

定理1.在一个异步网络模型的分布式系统中，是无法同时保证可用性和一致性的。

异步网络模型是没有时钟协调，各个节点仅通过收到远程消息并进行本地计算。异步网络模型的特点是被动的接受到消息并处理，而结果或请求也通过消息传递，但这个过程可能存在消息的丢失或者投递延迟。异步网络的效率高，但是相对可靠性差，主要就是没有过多的约束来强化可靠性。


反证法，存在一个算法，在异步网络的不同的节点{G1, G2}，能够满足CAP。都是初始值V0，这里就有P的要求，假定存在一个操作A，请求G1，将V0改为V1，在操作A之后有一个操作A’，读请求G2,由于G1和G2之间是异步网络，消息存在丢失和延迟，A’返回的值很有可能还是V0，这样就违反了一致性，因此不存在有类似算法在这种网络环境下，满足CAP。

在异步网络模型下，CAP无法做到，但是同时做到其中两个，还是可以的。
CP：如果选择交换A，那么CP是可以做到的。通过消息传递时的相互确认，能够确保一致性得以保证。特别是建立在分布式锁或者分布式多写方案上的分布式数据库，大都属于CP类型。当然它们对于A的交换并不是视而不见，而是通过一些高可用的手段加以保障，比如：一主多备的方式，来提升可用性，这种模式我们叫做CP+高可用。
CA：如果选择交换P，那么在一个中心化系统结构下，是比较容易做到CA的，在局域网中运作的系统，往往就是这种。
AP：如果选择交换C，一个高可靠和能够分区的分布式系统是很有价值的，比如：Web服务中的缓存，CDN，这种模式并不是对于一致性放任不管，而是允许弱一致性，或者说在一段时间后数据一定会一致，这就是我们常说的最终一致性

定理2.在一个部分同步网络模型的分布式系统中，是无法同时保证可用性和一致性的。
部分同步网络模型是存在网络时钟，每个分布式系统中的节点都会有一个时钟，这点看起来仿佛比异步网络模型没有强多少，但是在实际行为上还是比异步网络模型要强一些。部分同步网络由于节点存在时钟，那么就可以知道发送一个消息后，如果多长时间没有回执，那么就可以判定这个消息可能无效。在消息发送语境上就要比异步网络来的好。这样在部分同步网络上，就可以出现确定性的请求和应答机制，以及伴生而来的，不确定性的请求和应答机制（超时了，对方可能没有收到，判定当次请求失效）。
证明方式同异步网络模型一样，由于通信的不可靠性，这个分区的分布式系统，会存在违反一致性的问题，也就是说部分同步网络模型的分布式系统，也无法同时保证可用性和一致性。

在部分同步网络模型下，传输约束高于异步网络模型，可以做到有条件的弱一致性。由于该网络模型下能够确定消息传输的确定性，因此在一段时间的延迟，或者说可以预知的一段延迟下，能够达成P约束下的C，当然A也是做到的。
因为在分区的节点之间，已经就在P的约束下讨论问题，而确保每个节点能够正常工作，就要降低节点之间的耦合，任意节点的访问，不会要求其他节点的应答，这样就做到了A，而C是要求所有节点的数据能够一致，这点在部分同步网络模型下，节点之间数据完成同步传输的操作是可以预期的，而这个预期就是延迟，也就是说能够建立一个在一个延迟内可以一致的弱一致性分布式系统。


# CAP的简介

CAP是一致性、可用性以及分区容忍性的代指，而CAP理论要说明的是，针对这三个特性，一个分布式系统，同时只能满足两个。
CAP关注的是数据，需要关注延迟时间。BASE就是AP的一个成功实践，消息同步数据复制，都属于AP。
CAP在分区发生时，比如：数据按照主从分区了，那么只能取C或者A，目前看我们取得是A，而不是C。


C是Consistency，一致性，表示分布式系统的副本之间是一致的，或者说从外部看，能够有一致的存取和访问结果；
C与原子性等价，与ACID做一下类比。如果由于分区存在，分区之间数据不一致，对于C就不能兑现，但如果是最终一致性，损失的是即时的一致性，这样C会最终一致。

A是Avaiability，可用性，表示分布式系统的副本之间问题，出现了无法保证存取和访问的操作，如果不存在这个问题，在任何时间都能够提供服务，那么就具备可用性；
任何请求都能够得到满足。

P是Partition tolerance，分区容忍性，表示分布式系统多个副本（节点）之间能够封闭运行，能够避免一个副本（节点）出现问题，而出现全局问题。

# CAP的思考

分区容忍性需要考虑不同分区之间是无法访问的。一般意义上，分布式系统都会有P，那么在分布式系统中剩下的就是C和A选择哪个了。
如果是TDDL类似的系统，多个原子数据库之间不能相互访问，那么就剩下C和A的选择了，目前看选择了C。



C和A存在矛盾，一个看重一致性，一个是可用性。在P的前提下，分区不可避免，因此分区间的通信是不能保证绝对意义的高可靠，因此：
* 如果看重一致性，那么就要求多个分区之间的数据在更新时强一致，会在更新时锁定多个分区，而这个就导致可用性不能被满足
* 如果要保证可用性，就必须做到多个分区之间的更新不相互耦合，唯一可以想到的是异步进行更新，那么结果就是一致性不被满足

如果设计一个分布式数据存储系统，通过混合数据源来完成对业务需求的支持，方案是：MySQL+MongoDB。数据会从MySQL向MongoDB同步。
方案已经决定了是两个节点（副本），因此已经是P，这也就是说在分布式系统中，往往P是具备的，那么这个系统就要在C或者A中选择了。
如果选择C，这就要求所有的变更在多个副本（MySQL和MongoDB）中是一致的，这时会使用分布式事务，保障不同副本的数据一致性，但是二者之间的网络可能存在问题，导致整体的访问出现失败，这就是A不兑现。
如果选择A，可以看出当一方变动后，在网络中同步到对方，如果网络存在问题，将会在下次恢复时完成同步，但是数据在一个时刻，存在短暂的不一致，也就是C不兑现，但是用户的访问一致可以获得良好体验。

当选择AP后，对于同步，可以考虑硬件的支持，多条网线等方式。




