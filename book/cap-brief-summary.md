# CAP小结

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文是对CAP原理的简介、证明以及思考。其中理论证明部分主要来自于对**Gilbert**与**Lynch**的两篇论文（*《Brewer’s Conjecture and the Feasibility of Consistent, Available, Partition-Tolerant Web Services》* 和 *《Perspectives on the CAP Theorem》*）的理解。

## CAP原理简介

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CAP是一致性（**C**onsistency）、可用性（**A**vailability）以及分区容忍性（**P**artition Tolerance）的首字母缩写，而CAP原理要说明的是，针对这三种特性，一个分布式系统，同时只能满足两个。在分布式环境中，系统大都通过网络链接，彼此之间存在分区，所以分区容忍性往往是所处的现实基础，这个原理也可以这么说，在一个容易出现错误的分布式环境中，无法同时满足一致性和可用性。

<center>
<img src="https://weipeng2k.github.io/hot-wind/resources/cap-brief-summary/cap-theorem.png" width="50%" />
</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于三者不可得兼，而分区容忍性无法避免，所以业界既有很多CP和AP选择的分布式系统，比如：BASE思想（所谓软状态，最终一致性）就是AP的一种成功实践。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对三种特性，分别做一些解释。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**一致性（Consistency）**，表示分布式系统的不同分区的数据副本之间是一致的，这么定义有些严格，宽泛的讲，从外部请求这个分布式系统，能够有一致的存取和访问结果，先进行存储，后进行读取能够读到最新的值。如果由于分区的存在，导致分区之间数据不一致，这样一致性就无法兑现，但通过数据同步使得数据在一段延迟后重新一致，这种情况可以称之为最终一致性或者瞬时不一致。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**可用性（Avaiability）**，表示分布式系统在任何时刻都能够提供服务的能力。如果分布式系统能够在理论上满足任何时刻可以提供服务，那么这个分布式系统具备良好的可用性。如果由于分区的存在，导致系统从整体上看，有稳定性风险，那么该分布式系统的可用性是不足的。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**分区容忍性（Partition Tolerance）**，表示分布式系统多个分区（或者副本）之间能够封闭运行，可以在一个分区出现通信问题或者分区之间存在通信问题的情况下，系统对外表现工作良好。如果一个分布式系统，能够在分区或者分区之间通信不稳定的情况下稳定工作，那么表明该系统具备良好的分区容忍性。

## CAP原理证明

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在2000年的分布式计算原理会议（PODC）上，Brewer提出了一个猜想：对一个Web服务，是无法同时保证一致性、可用性和分区容忍性的。MIT的**Lynch**等人针对这个猜想做了详细的论证和分析，一定程度上形式化证明了该猜想，并基于该猜想，探讨了分布式环境下，如何能够更实际的认识、面对和处理这三者之间的关系。

### 异步网络模型下证明CAP

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**定理1. 在一个异步网络模型的分布式系统中，是无法同时保证可用性和一致性的。**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在异步网络模型下的分布式系统，各节点没有时钟协调，仅通过收到远程消息并进行本地计算来完成工作。异步网络模型的特点是被动的接受消息并处理，而结果也通过消息进行传递，这个过程可能存在消息的丢失或者消息（由于投递而）延迟。简单可以把它理解为一个完全有异步消息连接的分布式系统，各个节点如同一个个的任务，不断的消费消息，并产生消息，异步网络的效率高，但是相对可靠性差，原因就是没有过多的约束来强化可靠性。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**证明**：使用反证法。假定存在一个算法，在异步网络的不同的节点 *{G1, G2}*，能够同时满足CAP特性，其中*G1*和*G2*保存的数据为初始值*V0*。假定存在两个操作，其中：操作*A*，写请求*G1*，将*V0*改为*V1*；操作*B*，读请求*G2*，获取值。操作*A*先于操作*B*，由于当前算法满足CAP，所以操作*B*获取到的值是*V1*。由于*G1*和*G2*之间是异步网络，*G1*和*G2*之间的数据同步消息存在丢失和延迟，操作*B*返回的值很有可能还是*V0*，这样实际情况就违反了一致性，因此不存在有类似算法在异步网络模型的分布式系统中，同时满足CAP特性。证明的参考过程如下图所示：

<center>
<img src="https://weipeng2k.github.io/hot-wind/resources/cap-brief-summary/cap-async-prof.png" width="50%" />
</center>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过证明可以看出，在异步网络模型下，CAP特性无法同时满足，但是做到其中两个，还是可以的。如果选择CP，那么被交换的就是A，通过消息传递时的相互确认，能够确保一致性得以保证，特别是建立在分布式锁或者分布式多写方案上的数据存储服务，大都属于CP类型。当然它们对于A的交换并不是视而不见，而是通过一些备份的手段加以保障，比如：一主多备的方式，来提升一定可用性，避免长时间的宕机，这种模式一般叫做CP+高可用。如果选择CA，那么被交换的就是P，这样就在一个中心化系统结构下，是比较容易做到CA的，在局域网中运作的系统，往往就是这种，比如：局域网中部署一个MySQL实例，处于同一局域网的应用服务对其进行访问。如果选择AP，那么被交换的就是C，一个高可靠和能够分区的分布式系统是很有价值的，比如：Web服务中的缓存（或者CDN），这种选择并不是对于一致性放任不管，而是允许弱一致性，或者说在一段时间后数据一定会在不同分区形成一致，这就是我们常说的最终一致性。

### 部分同步网络模型下证明CAP

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**定理2. 在一个部分同步网络模型的分布式系统中，是无法同时保证可用性和一致性的。**

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;部分同步网络模型下的分布式系统，各个节点拥有一个时钟，时钟之间没有同步，是各个节点私有的，只是跳动频率一致，这点看起来仿佛比异步网络模型没有强多少，但是在实际功能上还是比异步网络模型要多一些。比如：部分同步网络由于节点时钟的存在，就可以知道发送一个消息后，如果多长时间没有回执，那么就可以判定这个消息可能无效，而异步网络模型无法做到这点。在部分同步网络模型下，可以实现确定性的请求和应答机制，以及随之而来的，“无效”的请求和应答机制（也就是调用超时，对方可能没有收到，判定当次请求无效）。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;证明方式同异步网络模型类似，都是由于通信的不可靠性，在部分同步网络模型的分布式系统中，不存在一个算法同时满足CAP特性。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在部分同步网络模型下，传输约束高于异步网络模型，可以做到有条件的弱一致性，这个有条件表示的是可预期的延迟。由于该网络模型下能够确定消息传输的确定性，因此在一段（或者说可以预知的）时间延迟下，能够在P的前提下达成C约。当然A也是可以做到的，因为在分区的节点之间，一个节点的访问，不会要求其他节点强参与，这样就做到了A。C是要求所有节点的数据能够一致，这点在部分同步网络模型下，分布式系统节点之间数据完成同步传输的操作（一般是同步消息传递）是可以预期的，所谓预期就是可预知时间的延迟，也就是说能够建立一个在特定时长后可以保证数据一致性的（弱一致性）分布式系统。